<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°¸ë¸Œì¬ ê°€ê²© ë¶„ì„ AI Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    
    .typing-dot { animation: typing 1.4s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
      30% { opacity: 1; transform: translateY(-4px); }
    }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Set Card Styles */
    .set-card {
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .set-card:hover {
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .set-card.active {
      border-color: #6366f1;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15);
    }
    .set-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    .set-body {
      padding: 20px;
    }
    
    /* Step chip for each set */
    .step-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .step-chip.pending {
      background: #f1f5f9;
      color: #64748b;
      border: 1px solid #e2e8f0;
    }
    .step-chip.pending:hover {
      background: #e2e8f0;
    }
    .step-chip.active {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      border: none;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.35);
    }
    .step-chip.completed {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
    }
    .step-chip.completed::before {
      content: 'âœ“';
      margin-right: 2px;
    }
    
    .table-container { max-height: 450px; overflow: auto; }
    .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
    .table-container::-webkit-scrollbar-track { background: #f8fafc; border-radius: 3px; }
    .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    
    .badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 4px;
      padding: 3px 10px; 
      border-radius: 6px; 
      font-size: 11px; 
      font-weight: 500;
    }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-gray { background: #f1f5f9; color: #475569; }
    .badge-purple { background: #f3e8ff; color: #7c3aed; }
    
    .stat-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px 16px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 14px rgba(99, 102, 241, 0.35);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 500;
      font-size: 13px;
    }
    
    table th { position: sticky; top: 0; z-index: 10; }
    
    .ai-report-box {
      background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
      border: 1px solid #d8b4fe;
      border-radius: 12px;
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
          <i class="ri-robot-2-fill text-white text-lg"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold text-slate-900 tracking-tight">ë°¸ë¸Œì¬ ê°€ê²© ë¶„ì„ AI Agent</h1>
          <p class="text-xs text-slate-400 font-medium">Valve Pricing Analysis System</p>
        </div>
      </div>
      <div id="api-status" class="flex items-center gap-2 text-sm"></div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-6">
    <!-- 3 Set Cards -->
    <div class="grid grid-cols-3 gap-4 mb-6">
      
      <!-- Set 1: PR ë‹¨ê°€ ì¶”ì²œ -->
      <div class="set-card bg-white" id="set-1" onclick="selectSet(1)">
        <div class="set-header bg-gradient-to-r from-indigo-50 to-blue-50">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center">
              <i class="ri-price-tag-3-line text-white text-sm"></i>
            </div>
            <h3 class="font-bold text-indigo-900">ë°¸ë¸Œì¬ PR ë‹¨ê°€ ì¶”ì²œ</h3>
          </div>
          <p class="text-xs text-indigo-600">êµ¬ë§¤ìš”ì²­ ê¸°ë°˜ ì ì •ë‹¨ê°€ ì‚°ì¶œ</p>
        </div>
        <div class="set-body">
          <div class="flex items-center gap-2 mb-3">
            <div class="step-chip pending" data-set="1" data-step="pr">PR ì ‘ìˆ˜</div>
            <i class="ri-arrow-right-s-line text-slate-300"></i>
            <div class="step-chip pending" data-set="1" data-step="a1">ë‹¨ê°€TBL</div>
            <div class="step-chip pending" data-set="1" data-step="a2">ë°œì£¼ì‹¤ì </div>
          </div>
          <div id="set1-summary" class="text-xs text-slate-400">ë¶„ì„ ì‹œì‘ ì „</div>
        </div>
      </div>
      
      <!-- Set 2: ì—…ì²´ ê²¬ì  ê²€ì¦ -->
      <div class="set-card bg-white" id="set-2" onclick="selectSet(2)">
        <div class="set-header bg-gradient-to-r from-emerald-50 to-teal-50">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center">
              <i class="ri-file-search-line text-white text-sm"></i>
            </div>
            <h3 class="font-bold text-emerald-900">ì—…ì²´ ê²¬ì  ê²€ì¦</h3>
          </div>
          <p class="text-xs text-emerald-600">í˜‘ë ¥ì‚¬ ê²¬ì ê°€ ì ì •ì„± ë¶„ì„</p>
        </div>
        <div class="set-body">
          <div class="flex items-center gap-2 mb-3">
            <div class="step-chip pending" data-set="2" data-step="quote">ê²¬ì  ìˆ˜ì‹ </div>
            <i class="ri-arrow-right-s-line text-slate-300"></i>
            <div class="step-chip pending" data-set="2" data-step="b1">ê³„ì•½ë¹„êµ</div>
            <div class="step-chip pending" data-set="2" data-step="b2">ì‹¤ì ë¹„êµ</div>
            <div class="step-chip pending" data-set="2" data-step="b3">ì ì •ì„±</div>
          </div>
          <div id="set2-summary" class="text-xs text-slate-400">ë¶„ì„ ì‹œì‘ ì „</div>
        </div>
      </div>
      
      <!-- Set 3: ì‹œí™© ë¶„ì„ -->
      <div class="set-card bg-white" id="set-3" onclick="selectSet(3)">
        <div class="set-header bg-gradient-to-r from-amber-50 to-orange-50">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-amber-500 rounded-lg flex items-center justify-center">
              <i class="ri-line-chart-line text-white text-sm"></i>
            </div>
            <h3 class="font-bold text-amber-900">ì‹¤ì ê°€ ê¸°ì¤€ ì‹œí™©ë¶„ì„</h3>
          </div>
          <p class="text-xs text-amber-600">LME ì›ìì¬ ì‹œí™© ëŒ€ë¹„ ë¶„ì„</p>
        </div>
        <div class="set-body">
          <div class="flex items-center gap-2 mb-3">
            <div class="step-chip pending" data-set="3" data-step="c">ì‹œí™©ë¶„ì„</div>
          </div>
          <div id="set3-summary" class="text-xs text-slate-400">ë¶„ì„ ì‹œì‘ ì „</div>
        </div>
      </div>
    </div>

    <!-- Agent Message & Results Area -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6" id="main-content">
      <div class="flex items-start gap-4 mb-6">
        <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-xl flex items-center justify-center flex-shrink-0">
          <i class="ri-robot-2-fill text-white text-lg"></i>
        </div>
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-sm font-bold text-indigo-700">AI Agent</span>
            <span class="badge badge-purple text-[10px]" id="current-step-label">ëŒ€ê¸°ì¤‘</span>
          </div>
          <div id="agent-message" class="text-slate-700 text-[14px] leading-relaxed">
            ë¶„ì„í•  ì—…ë¬´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. ê° ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
      
      <!-- Details Area -->
      <div id="agent-details" class="mb-6"></div>
      
      <!-- Results Table -->
      <div id="results-area" style="display: none;">
        <div class="flex items-center justify-between gap-4 mb-4" id="filter-bar"></div>
        <div class="table-container border border-slate-200 rounded-xl overflow-hidden">
          <table class="w-full text-sm" id="data-table">
            <thead class="bg-slate-50">
              <tr id="table-header"></tr>
            </thead>
            <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100">
          <div id="pagination-info" class="text-sm text-slate-500"></div>
          <div id="pagination-controls" class="flex items-center gap-1"></div>
        </div>
      </div>
    </div>

    <!-- AI Report Area -->
    <div class="ai-report-box p-5 mb-6" id="ai-report-area" style="display: none;">
      <div class="flex items-start gap-4">
        <div class="w-9 h-9 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center">
          <i class="ri-sparkling-2-fill text-white text-sm"></i>
        </div>
        <div class="flex-1">
          <h3 class="font-bold text-violet-900 mb-2 flex items-center gap-2 text-sm">
            <span>AI ë¶„ì„ ë¦¬í¬íŠ¸</span>
            <span class="badge badge-purple text-[10px]"><i class="ri-robot-line"></i> Claude</span>
          </h3>
          <div id="ai-report-text" class="text-slate-700 whitespace-pre-line leading-relaxed text-[13px]"></div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="flex items-center justify-between">
      <button id="btn-prev" onclick="prevStep()" class="btn-secondary flex items-center gap-2" disabled>
        <i class="ri-arrow-left-line"></i> ì´ì „
      </button>
      <button id="btn-next" onclick="nextStep()" class="btn-primary flex items-center gap-2">
        ë¶„ì„ ì‹œì‘ <i class="ri-arrow-right-line"></i>
      </button>
    </div>
  </main>

  <script>
    // State
    let currentSet = 0;
    let currentStepIndex = -1;
    let stepData = {};
    let currentPage = 1;
    const pageSize = 30;

    // Set definitions
    const sets = {
      1: {
        name: 'PR ë‹¨ê°€ ì¶”ì²œ',
        steps: [
          { id: 'pr', name: 'PR ì ‘ìˆ˜', api: '/api/set1/pr' },
          { id: 'a1', name: 'ë‹¨ê°€TBL ë§¤í•‘', api: '/api/step/a1' },
          { id: 'a2', name: 'ë°œì£¼ì‹¤ì  ë§¤í•‘', api: '/api/step/a2' }
        ]
      },
      2: {
        name: 'ê²¬ì  ê²€ì¦',
        steps: [
          { id: 'quote', name: 'ê²¬ì  ìˆ˜ì‹ ', api: '/api/set2/quote' },
          { id: 'b1', name: 'ê³„ì•½ë¹„êµ', api: '/api/step/b1' },
          { id: 'b2', name: 'ì‹¤ì ë¹„êµ', api: '/api/step/b2' },
          { id: 'b3', name: 'ì ì •ì„± íŒì •', api: '/api/step/b3' }
        ]
      },
      3: {
        name: 'ì‹œí™© ë¶„ì„',
        steps: [
          { id: 'c', name: 'ì‹œí™©ë¶„ì„', api: '/api/step/c' }
        ]
      }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkAPIStatus();
    });

    async function checkAPIStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        const statusEl = document.getElementById('api-status');
        if (data.apiKey?.configured) {
          statusEl.innerHTML = `<span class="w-2 h-2 bg-emerald-500 rounded-full"></span><span class="text-emerald-600 text-xs font-semibold">API ì—°ê²°ë¨</span>`;
        } else {
          statusEl.innerHTML = `<span class="w-2 h-2 bg-amber-500 rounded-full"></span><span class="text-amber-600 text-xs font-semibold">ë°ëª¨ ëª¨ë“œ</span>`;
        }
      } catch (e) { console.error('Status check failed:', e); }
    }

    function selectSet(setNum) {
      currentSet = setNum;
      currentStepIndex = -1;
      stepData = {};
      
      // Update card styles
      document.querySelectorAll('.set-card').forEach(card => {
        card.classList.remove('active');
      });
      document.getElementById(`set-${setNum}`).classList.add('active');
      
      // Reset all chips
      document.querySelectorAll('.step-chip').forEach(chip => {
        chip.classList.remove('active', 'completed');
        chip.classList.add('pending');
      });
      
      // Update UI
      const set = sets[setNum];
      document.getElementById('agent-message').innerHTML = `<strong>${set.name}</strong> ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. "ë‹¤ìŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`;
      document.getElementById('current-step-label').textContent = set.name;
      document.getElementById('agent-details').innerHTML = '';
      document.getElementById('results-area').style.display = 'none';
      document.getElementById('ai-report-area').style.display = 'none';
      
      document.getElementById('btn-next').disabled = false;
      document.getElementById('btn-next').innerHTML = 'ë¶„ì„ ì‹œì‘ <i class="ri-arrow-right-line"></i>';
      document.getElementById('btn-prev').disabled = true;
    }

    function updateStepChips() {
      if (!currentSet) return;
      const set = sets[currentSet];
      
      set.steps.forEach((step, idx) => {
        const chip = document.querySelector(`.step-chip[data-set="${currentSet}"][data-step="${step.id}"]`);
        if (!chip) return;
        
        chip.classList.remove('pending', 'active', 'completed');
        if (idx < currentStepIndex) {
          chip.classList.add('completed');
        } else if (idx === currentStepIndex) {
          chip.classList.add('active');
        } else {
          chip.classList.add('pending');
        }
      });
    }

    async function nextStep() {
      if (!currentSet) {
        alert('ë¨¼ì € ë¶„ì„í•  ì—…ë¬´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      currentStepIndex++;
      const set = sets[currentSet];
      
      if (currentStepIndex >= set.steps.length) {
        currentStepIndex = set.steps.length - 1;
        return;
      }
      
      updateStepChips();
      const step = set.steps[currentStepIndex];
      
      document.getElementById('current-step-label').textContent = `${set.name} > ${step.name}`;
      document.getElementById('agent-message').innerHTML = `
        <span class="text-slate-600">${step.name} ë¶„ì„ ì¤‘</span>
        <span class="typing-dot inline-block w-1.5 h-1.5 bg-indigo-500 rounded-full ml-1"></span>
        <span class="typing-dot inline-block w-1.5 h-1.5 bg-indigo-500 rounded-full ml-1"></span>
        <span class="typing-dot inline-block w-1.5 h-1.5 bg-indigo-500 rounded-full ml-1"></span>
      `;
      
      try {
        const res = await fetch(step.api);
        const data = await res.json();
        stepData[step.id] = data;
        renderStepResult(step, data);
        
        // Update summary
        updateSetSummary(currentSet, step, data);
      } catch (e) {
        console.error('Step failed:', e);
        document.getElementById('agent-message').innerHTML = `<span class="text-red-600">ì˜¤ë¥˜: ${e.message}</span>`;
      }
      
      document.getElementById('btn-prev').disabled = currentStepIndex === 0;
      if (currentStepIndex >= set.steps.length - 1) {
        document.getElementById('btn-next').innerHTML = 'ì™„ë£Œ <i class="ri-check-line"></i>';
        document.getElementById('btn-next').disabled = true;
      } else {
        document.getElementById('btn-next').innerHTML = 'ë‹¤ìŒ <i class="ri-arrow-right-line"></i>';
      }
    }

    function prevStep() {
      if (currentStepIndex > 0) {
        currentStepIndex--;
        updateStepChips();
        
        const set = sets[currentSet];
        const step = set.steps[currentStepIndex];
        
        document.getElementById('current-step-label').textContent = `${set.name} > ${step.name}`;
        if (stepData[step.id]) {
          renderStepResult(step, stepData[step.id]);
        }
        
        document.getElementById('btn-prev').disabled = currentStepIndex === 0;
        document.getElementById('btn-next').disabled = false;
        document.getElementById('btn-next').innerHTML = 'ë‹¤ìŒ <i class="ri-arrow-right-line"></i>';
      }
    }

    function updateSetSummary(setNum, step, data) {
      const summaryEl = document.getElementById(`set${setNum}-summary`);
      if (!summaryEl) return;
      
      if (data.summary) {
        const s = data.summary;
        if (setNum === 1) {
          if (step.id === 'pr') summaryEl.innerHTML = `<span class="text-indigo-600 font-medium">PR ${s.total?.toLocaleString() || 0}ê±´ ì ‘ìˆ˜</span>`;
          else if (step.id === 'a1') summaryEl.innerHTML = `<span class="text-indigo-600 font-medium">ë§¤í•‘ ${s.matchRate || '0%'} (íƒ€ì…+ì‚¬ì´ì¦ˆ: ${s.íƒ€ì…ì‚¬ì´ì¦ˆì¼ì¹˜ || 0}, íƒ€ì…: ${s.íƒ€ì…ì¼ì¹˜ || 0})</span>`;
          else if (step.id === 'a2') summaryEl.innerHTML = `<span class="text-indigo-600 font-medium">ë™ì¼ ${s.ë™ì¼ë‚´ì—­ || 0} / ìœ ì‚¬ ${s.ìœ ì‚¬íƒ€ì… || 0}</span>`;
        } else if (setNum === 2) {
          if (step.id === 'quote') summaryEl.innerHTML = `<span class="text-emerald-600 font-medium">ê²¬ì  ${s.total?.toLocaleString() || 0}ê±´</span>`;
          else if (step.id === 'b1') summaryEl.innerHTML = `<span class="text-emerald-600 font-medium">ë§¤í•‘ ${s.matchRate || '0%'}</span>`;
          else if (step.id === 'b3') summaryEl.innerHTML = `<span class="text-emerald-600 font-medium">ìš°ìˆ˜ ${s.ìš°ìˆ˜||0} / ë³´í†µ ${s.ë³´í†µ||0} / ë¶€ì ì ˆ ${s.ë¶€ì ì ˆ||0}</span>`;
        } else if (setNum === 3) {
          summaryEl.innerHTML = `<span class="text-amber-600 font-medium">ì–‘í˜¸ ${s.ì–‘í˜¸||0} / ì ì • ${s.ì ì •||0} / ì£¼ì˜ ${s.ì£¼ì˜||0}</span>`;
        }
      }
    }

    function renderStepResult(step, data) {
      const msgEl = document.getElementById('agent-message');
      const detailsEl = document.getElementById('agent-details');
      const resultsArea = document.getElementById('results-area');
      const aiReportArea = document.getElementById('ai-report-area');
      
      msgEl.innerHTML = `<span class="fade-in">${data.message || data.title || step.name}</span>`;
      aiReportArea.style.display = 'none';
      
      // Render based on step
      if (step.id === 'pr' || step.id === 'quote') {
        renderDataStep(data, detailsEl);
      } else if (step.id === 'a1') {
        renderA1Details(data, detailsEl);
      } else if (step.id === 'a2') {
        renderA2Details(data, detailsEl);
      } else if (step.id === 'b1') {
        renderB1Details(data, detailsEl);
      } else if (step.id === 'b2') {
        renderB2Details(data, detailsEl);
      } else if (step.id === 'b3') {
        renderB3Details(data, detailsEl);
        if (data.data?.some(d => d.AIì½”ë©˜íŠ¸)) {
          aiReportArea.style.display = 'block';
          document.getElementById('ai-report-text').innerHTML = formatAIComments(data.data);
        }
      } else if (step.id === 'c') {
        msgEl.innerHTML = `<span class="fade-in">ğŸŒ LME ì›ìì¬ ì‹œí™© ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤...</span>`;
        renderStepCDetails(data, detailsEl);
        if (data.aiReport) {
          aiReportArea.style.display = 'block';
          document.getElementById('ai-report-text').textContent = data.aiReport;
        }
      }
      
      // Render table if data exists
      if (data.data && data.data.length > 0) {
        renderDataTable(data.data, getFiltersForStep(step.id));
      } else if (data.trendResults) {
        renderDataTable(data.trendResults, getFiltersForStep(step.id));
      } else {
        resultsArea.style.display = 'none';
      }
    }

    function renderDataStep(data, container) {
      const s = data.summary || {};
      const prLabel = data.dataType === 'pr' ? 'PR ì ‘ìˆ˜ ê±´ìˆ˜' : 'ê²¬ì  ê±´ìˆ˜';
      container.innerHTML = `
        <div class="grid grid-cols-3 gap-3 fade-in">
          <div class="stat-card">
            <div class="text-2xl font-bold text-slate-800">${(s.total || 0).toLocaleString()}</div>
            <div class="text-xs text-slate-400 mt-1">${prLabel}</div>
          </div>
          <div class="stat-card">
            <div class="text-2xl font-bold text-indigo-600">${s.columns || 0}</div>
            <div class="text-xs text-slate-400 mt-1">ë°ì´í„° ì»¬ëŸ¼</div>
          </div>
          <div class="stat-card">
            <div class="text-2xl font-bold text-emerald-600">${(s.uniqueTypes || 0).toLocaleString()}</div>
            <div class="text-xs text-slate-400 mt-1">ë°¸ë¸Œ íƒ€ì…</div>
          </div>
        </div>
      `;
    }

    function renderA1Details(data, container) {
      const s = data.summary || {};
      container.innerHTML = `
        <div class="space-y-4 fade-in">
          <div class="bg-slate-50 rounded-xl p-4">
            <h4 class="font-semibold text-slate-700 mb-3 text-sm">ë‹¨ê°€TBL ë§¤í•‘ ê¸°ì¤€</h4>
            <div class="grid grid-cols-2 gap-2 text-xs">
              ${(data.rules || []).map(r => `
                <div class="flex items-start gap-2 text-slate-600 bg-white rounded-lg px-3 py-2 border border-slate-100">
                  <i class="ri-checkbox-circle-line text-indigo-500 mt-0.5"></i>
                  <span>${r}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="grid grid-cols-5 gap-3">
            <div class="stat-card text-center">
              <div class="text-2xl font-bold text-slate-800">${s.total || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ì „ì²´</div>
            </div>
            <div class="stat-card text-center border-t-2 border-emerald-500">
              <div class="text-2xl font-bold text-emerald-600">${s.matched || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë§¤í•‘ ì„±ê³µ</div>
            </div>
            <div class="stat-card text-center border-t-2 border-indigo-500">
              <div class="text-xl font-bold text-indigo-600">${s.íƒ€ì…ì‚¬ì´ì¦ˆì¼ì¹˜ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">íƒ€ì…+ì‚¬ì´ì¦ˆì¼ì¹˜</div>
            </div>
            <div class="stat-card text-center border-t-2 border-amber-500">
              <div class="text-xl font-bold text-amber-600">${s.íƒ€ì…ì¼ì¹˜ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">íƒ€ì…ì¼ì¹˜</div>
            </div>
            <div class="stat-card text-center border-t-2 border-red-500">
              <div class="text-2xl font-bold text-red-600">${s.unmatched || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë§¤í•‘ ì‹¤íŒ¨</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderA2Details(data, container) {
      const s = data.summary || {};
      container.innerHTML = `
        <div class="space-y-4 fade-in">
          <div class="bg-slate-50 rounded-xl p-4">
            <h4 class="font-semibold text-slate-700 mb-3 text-sm">ë°œì£¼ì‹¤ì  ë§¤í•‘ ê¸°ì¤€</h4>
            <div class="grid grid-cols-2 gap-2 text-xs">
              ${(data.rules || []).map(r => `
                <div class="flex items-start gap-2 text-slate-600 bg-white rounded-lg px-3 py-2 border border-slate-100">
                  <i class="ri-checkbox-circle-line text-indigo-500 mt-0.5"></i>
                  <span>${r}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="grid grid-cols-4 gap-3">
            <div class="stat-card text-center">
              <div class="text-2xl font-bold text-slate-800">${s.total || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ì „ì²´</div>
            </div>
            <div class="stat-card text-center border-t-2 border-emerald-500">
              <div class="text-2xl font-bold text-emerald-600">${s.ë™ì¼ë‚´ì—­ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë™ì¼ë‚´ì—­</div>
            </div>
            <div class="stat-card text-center border-t-2 border-amber-500">
              <div class="text-2xl font-bold text-amber-600">${s.ìœ ì‚¬íƒ€ì… || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ìœ ì‚¬íƒ€ì…</div>
            </div>
            <div class="stat-card text-center border-t-2 border-red-500">
              <div class="text-2xl font-bold text-red-600">${s.ë¯¸ë§¤í•‘ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë¯¸ë§¤í•‘</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderB1Details(data, container) {
      const s = data.summary || {};
      container.innerHTML = `
        <div class="space-y-4 fade-in">
          <div class="bg-slate-50 rounded-xl p-4">
            <h4 class="font-semibold text-slate-700 mb-3 text-sm">ê³„ì•½ë‹¨ê°€ ë¹„êµ ê¸°ì¤€</h4>
            <div class="grid grid-cols-2 gap-2 text-xs">
              ${(data.rules || []).map(r => `
                <div class="flex items-start gap-2 text-slate-600 bg-white rounded-lg px-3 py-2 border border-slate-100">
                  <i class="ri-checkbox-circle-line text-emerald-500 mt-0.5"></i>
                  <span>${r}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="grid grid-cols-5 gap-3">
            <div class="stat-card text-center">
              <div class="text-2xl font-bold text-slate-800">${s.total || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ì „ì²´ ê²¬ì </div>
            </div>
            <div class="stat-card text-center border-t-2 border-emerald-500">
              <div class="text-2xl font-bold text-emerald-600">${s.matched || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë§¤í•‘ ì„±ê³µ</div>
            </div>
            <div class="stat-card text-center border-t-2 border-indigo-500">
              <div class="text-xl font-bold text-indigo-600">${s.íƒ€ì…ì‚¬ì´ì¦ˆì¼ì¹˜ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">íƒ€ì…+ì‚¬ì´ì¦ˆì¼ì¹˜</div>
            </div>
            <div class="stat-card text-center border-t-2 border-amber-500">
              <div class="text-xl font-bold text-amber-600">${s.íƒ€ì…ì¼ì¹˜ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">íƒ€ì…ì¼ì¹˜</div>
            </div>
            <div class="stat-card text-center border-t-2 border-red-500">
              <div class="text-2xl font-bold text-red-600">${s.unmatched || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë§¤í•‘ ì‹¤íŒ¨</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderB2Details(data, container) {
      const s = data.summary || {};
      container.innerHTML = `
        <div class="space-y-4 fade-in">
          <div class="bg-slate-50 rounded-xl p-4">
            <h4 class="font-semibold text-slate-700 mb-3 text-sm">ë°œì£¼ì‹¤ì  ë¹„êµ ê¸°ì¤€</h4>
            <div class="grid grid-cols-2 gap-2 text-xs">
              ${(data.rules || []).map(r => `
                <div class="flex items-start gap-2 text-slate-600 bg-white rounded-lg px-3 py-2 border border-slate-100">
                  <i class="ri-checkbox-circle-line text-emerald-500 mt-0.5"></i>
                  <span>${r}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="grid grid-cols-4 gap-3">
            <div class="stat-card text-center">
              <div class="text-2xl font-bold text-slate-800">${s.total || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ì „ì²´</div>
            </div>
            <div class="stat-card text-center border-t-2 border-emerald-500">
              <div class="text-2xl font-bold text-emerald-600">${s.ë™ì¼ë‚´ì—­ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë™ì¼ë‚´ì—­</div>
            </div>
            <div class="stat-card text-center border-t-2 border-amber-500">
              <div class="text-2xl font-bold text-amber-600">${s.ìœ ì‚¬íƒ€ì… || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ìœ ì‚¬íƒ€ì…</div>
            </div>
            <div class="stat-card text-center border-t-2 border-red-500">
              <div class="text-2xl font-bold text-red-600">${s.ë¯¸ë§¤í•‘ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë¯¸ë§¤í•‘</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderB3Details(data, container) {
      const s = data.summary || {};
      const total = s.total || 1;
      container.innerHTML = `
        <div class="space-y-4 fade-in">
          <div class="bg-slate-50 rounded-xl p-4">
            <h4 class="font-semibold text-slate-700 mb-3 text-sm">ì ì •ì„± íŒì • ê¸°ì¤€</h4>
            <div class="grid grid-cols-3 gap-2 text-xs">
              ${(data.rules || []).map(r => `
                <div class="flex items-start gap-2 text-slate-600 bg-white rounded-lg px-3 py-2 border border-slate-100">
                  <i class="ri-checkbox-circle-line text-emerald-500 mt-0.5"></i>
                  <span>${r}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="grid grid-cols-4 gap-3">
            <div class="stat-card text-center border-t-2 border-emerald-500">
              <div class="text-2xl font-bold text-emerald-600">${s.ìš°ìˆ˜ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ìš°ìˆ˜</div>
              <div class="text-[9px] text-slate-300">${Math.round((s.ìš°ìˆ˜||0)/total*100)}%</div>
            </div>
            <div class="stat-card text-center border-t-2 border-amber-500">
              <div class="text-2xl font-bold text-amber-600">${s.ë³´í†µ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë³´í†µ</div>
              <div class="text-[9px] text-slate-300">${Math.round((s.ë³´í†µ||0)/total*100)}%</div>
            </div>
            <div class="stat-card text-center border-t-2 border-red-500">
              <div class="text-2xl font-bold text-red-600">${s.ë¶€ì ì ˆ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë¶€ì ì ˆ</div>
              <div class="text-[9px] text-slate-300">${Math.round((s.ë¶€ì ì ˆ||0)/total*100)}%</div>
            </div>
            <div class="stat-card text-center border-t-2 border-slate-400">
              <div class="text-2xl font-bold text-slate-600">${s.íŒë‹¨ë¶ˆê°€ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">íŒë‹¨ë¶ˆê°€</div>
              <div class="text-[9px] text-slate-300">${Math.round((s.íŒë‹¨ë¶ˆê°€||0)/total*100)}%</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderStepCDetails(data, container) {
      const s = data.summary || {};
      const target = data.targetInfo || {};
      const total = (s.ì–‘í˜¸||0) + (s.ì ì •||0) + (s.ì£¼ì˜||0) || 1;
      container.innerHTML = `
        <div class="space-y-4 fade-in">
          <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
            <h4 class="font-semibold text-amber-800 mb-2 text-sm">ğŸ“Š ë¶„ì„ ëŒ€ìƒ ë°¸ë¸Œ</h4>
            <div class="text-xs text-amber-700">
              <span class="font-bold">${target.valveType || 'VGBARR240AT'}</span> (Bronze Casting, Cu+Sn í•©ê¸ˆ)
              <br><span class="text-amber-600">${target.description || 'LOCK ì˜µì…˜ ì œì™¸, TR íƒ€ì…ë§Œ'}</span>
              <br><span class="font-medium">ë¶„ì„ ëŒ€ìƒ: ${(s.targetCount || 0).toLocaleString()}ê±´</span>
            </div>
          </div>
          <div class="bg-slate-50 rounded-xl p-4">
            <h4 class="font-semibold text-slate-700 mb-3 text-sm">ì‹œí™© ëŒ€ë¹„ íŒì • ê¸°ì¤€</h4>
            <div class="grid grid-cols-3 gap-2 text-xs">
              <div class="flex items-center gap-2 bg-white rounded-lg p-3 border border-slate-200">
                <span class="badge badge-success">ì–‘í˜¸</span>
                <span class="text-slate-600">ì‹œí™©â†‘ ë‹¨ê°€ ìœ ì§€/í•˜ë½</span>
              </div>
              <div class="flex items-center gap-2 bg-white rounded-lg p-3 border border-slate-200">
                <span class="badge badge-warning">ì ì •</span>
                <span class="text-slate-600">ì‹œí™©ê³¼ ë‹¨ê°€ ë™ì¼ë°©í–¥</span>
              </div>
              <div class="flex items-center gap-2 bg-white rounded-lg p-3 border border-slate-200">
                <span class="badge badge-danger">ì£¼ì˜</span>
                <span class="text-slate-600">ì‹œí™©â†“ ë‹¨ê°€ ìƒìŠ¹</span>
              </div>
            </div>
          </div>
          ${data.yearSummary ? `
          <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
            <h4 class="font-semibold text-blue-800 mb-2 text-sm">ğŸ“ˆ 2025ë…„ ì „ì²´ ìš”ì•½</h4>
            <div class="grid grid-cols-4 gap-3 text-center">
              <div>
                <div class="text-lg font-bold text-blue-700">${data.yearSummary.avgPrice?.toLocaleString() || '-'}</div>
                <div class="text-[10px] text-blue-500">í‰ê· ë‹¨ê°€</div>
              </div>
              <div>
                <div class="text-lg font-bold text-blue-700">${data.yearSummary.totalOrders?.toLocaleString() || '-'}</div>
                <div class="text-[10px] text-blue-500">ì´ ë°œì£¼ê±´</div>
              </div>
              <div>
                <div class="text-lg font-bold ${data.yearSummary.priceChange >= 0 ? 'text-red-600' : 'text-emerald-600'}">${data.yearSummary.priceChange >= 0 ? '+' : ''}${data.yearSummary.priceChange?.toFixed(1) || 0}%</div>
                <div class="text-[10px] text-blue-500">ë‹¨ê°€ë³€ë™</div>
              </div>
              <div>
                <div class="text-lg font-bold ${data.yearSummary.marketChange >= 0 ? 'text-red-600' : 'text-emerald-600'}">${data.yearSummary.marketChange >= 0 ? '+' : ''}${data.yearSummary.marketChange?.toFixed(1) || 0}%</div>
                <div class="text-[10px] text-blue-500">ì‹œí™©ë³€ë™</div>
              </div>
            </div>
          </div>
          ` : ''}
          <div class="grid grid-cols-4 gap-3">
            <div class="stat-card text-center">
              <div class="text-2xl font-bold text-slate-800">${(s.targetCount || 0).toLocaleString()}</div>
              <div class="text-[10px] text-slate-400 mt-1">ë¶„ì„ ëŒ€ìƒ</div>
            </div>
            <div class="stat-card text-center border-t-2 border-emerald-500">
              <div class="text-2xl font-bold text-emerald-600">${s.ì–‘í˜¸ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ì–‘í˜¸</div>
              <div class="text-[9px] text-slate-300">${Math.round((s.ì–‘í˜¸||0)/total*100)}%</div>
            </div>
            <div class="stat-card text-center border-t-2 border-amber-500">
              <div class="text-2xl font-bold text-amber-600">${s.ì ì • || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ì ì •</div>
              <div class="text-[9px] text-slate-300">${Math.round((s.ì ì •||0)/total*100)}%</div>
            </div>
            <div class="stat-card text-center border-t-2 border-red-500">
              <div class="text-2xl font-bold text-red-600">${s.ì£¼ì˜ || 0}</div>
              <div class="text-[10px] text-slate-400 mt-1">ì£¼ì˜</div>
              <div class="text-[9px] text-slate-300">${Math.round((s.ì£¼ì˜||0)/total*100)}%</div>
            </div>
          </div>
        </div>
      `;
    }

    function formatAIComments(data) {
      if (!data || data.length === 0) return 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
      const withComments = data.filter(c => c.AIì½”ë©˜íŠ¸);
      if (withComments.length === 0) return 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
      return withComments.slice(0, 5).map((c, i) => `
        <div class="mb-4 pb-4 ${i < 4 ? 'border-b border-violet-100' : ''}">
          <div class="flex items-center gap-2 mb-2">
            <span class="font-semibold text-violet-800 text-sm">${c.ìì¬ë²ˆí˜¸ || c.No || `#${i+1}`}</span>
            <span class="badge ${c.ì ì •ì„± === 'ìš°ìˆ˜' ? 'badge-success' : c.ì ì •ì„± === 'ë³´í†µ' ? 'badge-warning' : 'badge-danger'}">${c.ì ì •ì„±}</span>
          </div>
          <p class="text-slate-600 text-sm leading-relaxed">${c.AIì½”ë©˜íŠ¸}</p>
        </div>
      `).join('');
    }

    function getFiltersForStep(stepId) {
      const configs = {
        'a1': [{ key: 'ë§¤í•‘ìƒíƒœ', options: ['ì „ì²´', 'ì„±ê³µ', 'ì‹¤íŒ¨'] }, { key: 'ë§¤í•‘ìœ í˜•', options: ['ì „ì²´', 'íƒ€ì…+ì‚¬ì´ì¦ˆì¼ì¹˜', 'íƒ€ì…ì¼ì¹˜'] }],
        'a2': [{ key: 'ë§¤í•‘ìœ í˜•', options: ['ì „ì²´', 'ë™ì¼ë‚´ì—­', 'ìœ ì‚¬íƒ€ì…', 'ë¯¸ë§¤í•‘'] }],
        'b1': [{ key: 'ë§¤í•‘ìƒíƒœ', options: ['ì „ì²´', 'ì„±ê³µ', 'ì‹¤íŒ¨'] }, { key: 'ë§¤í•‘ìœ í˜•', options: ['ì „ì²´', 'íƒ€ì…+ì‚¬ì´ì¦ˆì¼ì¹˜', 'íƒ€ì…ì¼ì¹˜'] }],
        'b2': [{ key: 'ë§¤í•‘ìœ í˜•', options: ['ì „ì²´', 'ë™ì¼ë‚´ì—­', 'ìœ ì‚¬íƒ€ì…', 'ë¯¸ë§¤í•‘'] }],
        'b3': [{ key: 'ì ì •ì„±', options: ['ì „ì²´', 'ìš°ìˆ˜', 'ë³´í†µ', 'ë¶€ì ì ˆ', 'íŒë‹¨ë¶ˆê°€'] }],
        'c': [{ key: 'ì ì •ì„±', options: ['ì „ì²´', 'ì–‘í˜¸', 'ì ì •', 'ì£¼ì˜'] }]
      };
      return configs[stepId] || [];
    }

    let currentFilter = {};
    
    function renderDataTable(data, filters) {
      if (!data || data.length === 0) {
        document.getElementById('results-area').style.display = 'none';
        return;
      }

      const resultsArea = document.getElementById('results-area');
      resultsArea.style.display = 'block';

      const filterBar = document.getElementById('filter-bar');
      if (filters.length > 0) {
        filterBar.innerHTML = `
          <div class="flex gap-3">
            ${filters.map(f => `
              <div class="flex items-center gap-2">
                <label class="text-xs font-semibold text-slate-500">${f.key}</label>
                <select onchange="applyFilter('${f.key}', this.value)" class="border border-slate-200 rounded-lg px-3 py-1.5 text-xs bg-white">
                  ${f.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                </select>
              </div>
            `).join('')}
          </div>
          <div class="text-xs text-slate-400 font-medium" id="filter-count"></div>
        `;
      } else {
        filterBar.innerHTML = '';
      }

      currentFilter = {};
      currentPage = 1;
      renderTableData(data);
    }

    function applyFilter(key, value) {
      if (value === 'ì „ì²´') {
        delete currentFilter[key];
      } else {
        currentFilter[key] = value;
      }
      currentPage = 1;
      
      const set = sets[currentSet];
      const step = set.steps[currentStepIndex];
      const data = stepData[step.id]?.data || stepData[step.id]?.trendResults || [];
      renderTableData(data);
    }

    function renderTableData(allData) {
      let filteredData = allData;
      for (const [key, value] of Object.entries(currentFilter)) {
        filteredData = filteredData.filter(row => row[key] === value);
      }

      const filterCount = document.getElementById('filter-count');
      if (filterCount) filterCount.textContent = `${filteredData.length.toLocaleString()}ê±´`;

      const totalPages = Math.ceil(filteredData.length / pageSize);
      const startIdx = (currentPage - 1) * pageSize;
      const pageData = filteredData.slice(startIdx, startIdx + pageSize);

      // ìˆ¨ê¸¸ ì»¬ëŸ¼ ëª©ë¡
      const hideColumns = ['AIì½”ë©˜íŠ¸', 'vtype_key', 'ì˜µì…˜ìƒì„¸'];
      const columns = pageData.length > 0 ? Object.keys(pageData[0]).filter(k => !hideColumns.includes(k)) : [];
      
      document.getElementById('table-header').innerHTML = columns.map(col => 
        `<th class="px-3 py-2.5 text-left text-[10px] font-bold text-slate-500 bg-slate-50 whitespace-nowrap uppercase tracking-wider">${col}</th>`
      ).join('');

      document.getElementById('table-body').innerHTML = pageData.map(row => `
        <tr class="hover:bg-indigo-50/50 transition-colors">
          ${columns.map(col => `<td class="px-3 py-2 text-xs text-slate-700 whitespace-nowrap">${formatCellValue(col, row[col])}</td>`).join('')}
        </tr>
      `).join('');

      document.getElementById('pagination-info').textContent = 
        `${filteredData.length.toLocaleString()}ê±´ ì¤‘ ${startIdx + 1}-${Math.min(startIdx + pageSize, filteredData.length)}`;

      const paginationControls = document.getElementById('pagination-controls');
      if (totalPages > 1) {
        let pages = [];
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            pages.push(i);
          } else if (pages[pages.length - 1] !== '...') {
            pages.push('...');
          }
        }
        paginationControls.innerHTML = `
          <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="w-7 h-7 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-100 disabled:opacity-40 flex items-center justify-center text-xs">
            <i class="ri-arrow-left-s-line"></i>
          </button>
          ${pages.map(p => p === '...' 
            ? '<span class="px-1 text-slate-400 text-xs">...</span>'
            : `<button onclick="changePage(${p})" class="w-7 h-7 rounded-lg text-xs font-semibold ${p === currentPage ? 'bg-indigo-500 text-white' : 'text-slate-600 hover:bg-slate-100'}">${p}</button>`
          ).join('')}
          <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="w-7 h-7 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-100 disabled:opacity-40 flex items-center justify-center text-xs">
            <i class="ri-arrow-right-s-line"></i>
          </button>
        `;
      } else {
        paginationControls.innerHTML = '';
      }
    }

    function changePage(page) {
      currentPage = page;
      const set = sets[currentSet];
      const step = set.steps[currentStepIndex];
      const data = stepData[step.id]?.data || stepData[step.id]?.trendResults || [];
      renderTableData(data);
    }

    function formatCellValue(col, val) {
      if (val === null || val === undefined || val === '') return '<span class="text-slate-300">-</span>';
      
      if (col === 'ë§¤í•‘ìƒíƒœ') {
        return val === 'ì„±ê³µ' 
          ? `<span class="badge badge-success text-[10px]"><i class="ri-check-line"></i> ${val}</span>`
          : `<span class="badge badge-danger text-[10px]"><i class="ri-close-line"></i> ${val}</span>`;
      }
      if (col === 'ë§¤í•‘ìœ í˜•') {
        if (val === 'ë™ì¼ë‚´ì—­' || val === 'íƒ€ì…+ì‚¬ì´ì¦ˆì¼ì¹˜') return `<span class="badge badge-success text-[10px]">${val}</span>`;
        if (val === 'ìœ ì‚¬íƒ€ì…' || val === 'íƒ€ì…ì¼ì¹˜') return `<span class="badge badge-warning text-[10px]">${val}</span>`;
        return `<span class="badge badge-danger text-[10px]">${val}</span>`;
      }
      if (col === 'ì ì •ì„±') {
        if (val === 'ìš°ìˆ˜' || val === 'ì–‘í˜¸') return `<span class="badge badge-success text-[10px]">${val}</span>`;
        if (val === 'ë³´í†µ' || val === 'ì ì •') return `<span class="badge badge-warning text-[10px]">${val}</span>`;
        if (val === 'ë¶€ì ì ˆ' || val === 'ì£¼ì˜') return `<span class="badge badge-danger text-[10px]">${val}</span>`;
        return `<span class="badge badge-gray text-[10px]">${val}</span>`;
      }
      
      // ì°¨ì´ ì»¬ëŸ¼ ì²˜ë¦¬ (í¼ì„¼í‹°ì§€ ë¬¸ìì—´)
      if (col === 'ì°¨ì´' || col === 'ì°¨ì´ìœ¨') {
        if (typeof val === 'string' && val.includes('%')) {
          const isPositive = val.startsWith('+');
          const isNegative = val.startsWith('-');
          const color = isPositive ? 'text-red-600' : isNegative ? 'text-emerald-600' : 'text-slate-600';
          return `<span class="${color} font-semibold">${val}</span>`;
        }
        if (typeof val === 'number') {
          const color = val > 0 ? 'text-red-600' : val < 0 ? 'text-emerald-600' : 'text-slate-600';
          return `<span class="${color} font-semibold">${val > 0 ? '+' : ''}${val.toFixed(1)}%</span>`;
        }
      }

      if (typeof val === 'number') {
        if (col.includes('ë³€ë™') || col.includes('%')) {
          const color = val > 0 ? 'text-red-600' : val < 0 ? 'text-emerald-600' : 'text-slate-600';
          return `<span class="${color} font-semibold">${val > 0 ? '+' : ''}${typeof val === 'number' ? val.toFixed(1) : val}%</span>`;
        }
        if (col.includes('ì´ìµ') || col.includes('ì†í•´')) {
          const color = val > 0 ? 'text-emerald-600' : val < 0 ? 'text-red-600' : 'text-slate-600';
          return `<span class="${color} font-semibold">${val > 0 ? '+' : ''}${val.toLocaleString()}</span>`;
        }
        if (col.includes('ë‹¨ê°€') || col.includes('ê¸ˆì•¡') || col.includes('ê°€') || col.includes('ì•¡')) {
          return `<span class="font-medium">${val.toLocaleString()}</span>`;
        }
        return val.toLocaleString();
      }

      if (typeof val === 'string' && val.length > 30) {
        return `<span title="${val}" class="cursor-help">${val.substring(0, 28)}...</span>`;
      }

      return val;
    }
  </script>
</body>
</html>
