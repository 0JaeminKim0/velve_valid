# Valve Pricing AI Agent

밸브재 가격 분석 AI Agent - 조선업 밸브 구매가격 검증 시스템

## 🚀 실행 방법

### 로컬 개발
```bash
npm install
npm run dev
```

### 프로덕션 빌드
```bash
npm run build
npm start
```

## 📦 Railway 배포

### 환경변수 설정
- `ANTHROPIC_API_KEY`: Claude API 키 (AI 코멘트 생성용)
- `PORT`: 서버 포트 (Railway가 자동 설정)

### 배포 명령어
Railway CLI 또는 GitHub 연동으로 자동 배포

## 🔧 기술 스택
- **Backend**: Hono + Node.js + TypeScript
- **Frontend**: HTML + TailwindCSS + Chart.js
- **Data**: xlsx 라이브러리로 Excel 직접 파싱
- **AI**: Anthropic Claude API

## 📊 분석 단계
1. **Step 0**: 데이터 로딩
2. **Step 1**: 데이터 전처리
3. **Step A-1**: 계약단가 기준 추천가 산출
4. **Step A-2**: 발주실적 기준 예상가 산출
5. **Step B-1**: 견적 vs 계약단가 비교 + 차이 원인 분석
6. **Step B-2**: 견적 vs 발주실적 비교
7. **Step B-3**: 가격 적정성 판정 + 시황 팝업 + 자동 PO 발행
8. **Step B-4**: AI 분석 코멘트 생성
9. **Step C**: 시황 대비 가격 분석 (추정이익/손해 표시)
10. **Step C-1**: AI 시황 종합 리포트

## ✨ 최근 추가 기능 (2025-02)

### 견적가 vs 계약총액 차이 원인 분석
- B1 계약비교 테이블에 **원인** 컬럼 추가
- 본체가, N/P, 외부도장, 내부도장, LOCK 등 구성요소별 차이 표시
- 예시: `외부도장 +7,821` 또는 `본체가 -1,661, 외부도장 +13,129`
- 차이가 100원 미만이면 `일치`로 표시

### 시황분석 추정이익/손해액 개선
- **이익(+)**: 시황변동% > 단가변동% (원가 상승 대비 단가 인상 억제)
- **손해(-)**: 시황변동% < 단가변동% (원가 변동 대비 단가 과다 인상)
- 계산식: `(시황변동% - 단가변동%) × 현재단가 × 건수 / 100`

### 적정성 판정 시황 버튼
- B3 적정성 테이블에 **📈 시황** 버튼 추가
- 클릭 시 해당 밸브의 시황 분석 팝업 표시
- 2025년 전체 요약, 월별 트렌드, AI 분석 리포트 포함

### 자동 PO 발행 팝업
- B3 적정성 분석 완료 후 자동 PO 대상 팝업 표시
- **조건**: 견적가 ≤ 협상목표가 (최근발주가 × 90%)
- 전체 건수 중 달성 건수, 달성률, 총 PO 금액, 절감액 표시
- 0건이어도 팝업 표시 (현재 데이터: 0건 / 159건)
